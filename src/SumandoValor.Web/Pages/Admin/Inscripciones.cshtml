@page
@model SumandoValor.Web.Pages.Admin.InscripcionesModel
@using SumandoValor.Domain.Entities
@{
    ViewData["Title"] = "Gestión de Inscripciones";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="mb-4">
    <h1>Gestión de Inscripciones</h1>
    <div class="d-flex gap-2 flex-wrap align-items-center">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inscribirModal">
            <i class="bi bi-person-plus me-1"></i>Inscribir Usuario
        </button>
        <form method="post" asp-page-handler="ExportCsv" class="d-inline">
            <button type="submit" class="btn btn-outline-primary">Exportar CSV</button>
        </form>
        <select id="tallerFilter" class="form-select d-inline" style="width: auto;">
            <option value="">Todos los talleres</option>
            @foreach (var taller in Model.TalleresDisponibles)
            {
                <option value="@taller.Id" selected="@(Model.TallerIdFiltro == taller.Id)">@taller.Titulo</option>
            }
        </select>
    </div>
</div>

<!-- Modal para inscribir usuario -->
<div class="modal fade" id="inscribirModal" tabindex="-1" aria-labelledby="inscribirModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inscribirModalLabel">Inscribir Usuario en Taller</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="InscribirUsuario">
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    
                    <div class="mb-3">
                        <label for="tallerSelect" class="form-label">Taller *</label>
                        <select name="tallerId" id="tallerSelect" class="form-select" required>
                            <option value="">Seleccionar taller...</option>
                            @foreach (var taller in Model.TalleresDisponibles.Where(t => t.Estatus == EstatusTaller.Abierto))
                            {
                                <option value="@taller.Id">@taller.Titulo - @taller.Curso.Titulo (@taller.CuposDisponibles cupos disponibles)</option>
                            }
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="usuarioSearch" class="form-label">Buscar Usuario *</label>
                        <input type="text" id="usuarioSearch" class="form-control" placeholder="Buscar por nombre o email..." autocomplete="off" />
                        <input type="hidden" name="userId" id="usuarioSelect" required />
                        <div id="usuarioResults" class="list-group mt-2" style="max-height: 200px; overflow-y: auto; display: none;"></div>
                        <small class="text-muted">Escribe para buscar usuarios por nombre o email</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Inscribir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="table-responsive">
    <div class="mb-3 d-flex gap-2">
        <button type="submit" asp-page-handler="UpdateAttendanceBatch" asp-route-attended="true" form="batchForm" class="btn btn-primary btn-sm">
            <i class="bi bi-check2-all me-1"></i>Marcar Asistencia
        </button>
        <button type="submit" asp-page-handler="UpdateAttendanceBatch" asp-route-attended="false" form="batchForm" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-x me-1"></i>Desmarcar Asistencia
        </button>
    </div>

    <form method="post" id="batchForm">
    <div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th style="width: 30px;">
                    <input type="checkbox" class="form-check-input" id="selectAll" />
                </th>
                <th>Taller</th>
                <th>Usuario</th>
                <th>Email</th>
                <th>Fecha Inscripción</th>
                <th>Estado</th>
                <th>Asistencia</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var group in Model.Inscripciones.GroupBy(i => i.Inscripcion.Taller).OrderByDescending(g => g.Key.FechaInicio))
            {
                <tr class="table-secondary">
                    <td colspan="8" class="fw-bold">
                        <i class="bi bi-calendar-event me-2"></i>@group.Key.Titulo 
                        <span class="fw-normal text-muted small ms-2">(@group.Key.Curso.Titulo)</span>
                    </td>
                </tr>
                @foreach (var item in group)
                {
                    var inscripcion = item.Inscripcion;
                    var user = item.User;
                    <tr>
                        <td>
                            <input type="checkbox" name="SelectedInscripcionIds" value="@inscripcion.Id" class="form-check-input form-check-inputRow" />
                        </td>
                        <td>@inscripcion.Taller.Curso.Titulo</td>
                        <td>@user.Nombres @user.Apellidos</td>
                        <td>@user.Email</td>
                        <td>@inscripcion.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>
                            @if (inscripcion.Estado == EstadoInscripcion.Activa)
                            {
                                <span class="badge bg-success">Activa</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Cancelada</span>
                            }
                        </td>
                        <td>
                            @if (inscripcion.Asistencia)
                            {
                                <span class="badge bg-info">Sí</span>
                            }
                            else
                            {
                                <span class="text-muted">No</span>
                            }
                        </td>
                        <td class="text-center">
                            <div class="admin-actions">
                                <form method="post" asp-page-handler="ToggleAsistencia" asp-route-id="@inscripcion.Id" class="m-0">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        @(inscripcion.Asistencia ? "Quitar" : "Asistir")
                                    </button>
                                </form>
                                @if (inscripcion.Estado == EstadoInscripcion.Activa)
                                {
                                    <form method="post" asp-page-handler="Cancelar" asp-route-id="@inscripcion.Id" class="m-0">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Está seguro de cancelar esta inscripción?');">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
    </div>
    </form>
</div>

@section Scripts {
    <script>
        document.getElementById('tallerFilter').addEventListener('change', function() {
            const tallerId = this.value;
            const url = new URL(window.location);
            if (tallerId) {
                url.searchParams.set('tallerId', tallerId);
            } else {
                url.searchParams.delete('tallerId');
            }
            window.location.href = url.toString();
        });

        // Búsqueda de usuarios
        const usuarioSearch = document.getElementById('usuarioSearch');
        const usuarioSelect = document.getElementById('usuarioSelect');
        const usuarioResults = document.getElementById('usuarioResults');
        const usuarios = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.UsuariosDisponibles.Select(u => new { u.Id, u.Nombres, u.Apellidos, u.Email })));

        let searchTimeout;
        usuarioSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase().trim();
            
            if (query.length < 2) {
                usuarioResults.style.display = 'none';
                usuarioSelect.value = '';
                return;
            }

            searchTimeout = setTimeout(function() {
                const filtered = usuarios.filter(function(u) {
                    const nombreCompleto = (u.Nombres + ' ' + u.Apellidos).toLowerCase();
                    const email = (u.Email || '').toLowerCase();
                    return nombreCompleto.includes(query) || email.includes(query);
                });

                usuarioResults.innerHTML = '';
                if (filtered.length === 0) {
                    usuarioResults.innerHTML = '<div class="list-group-item text-muted">No se encontraron usuarios</div>';
                } else {
                    filtered.slice(0, 10).forEach(function(user) {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = '<strong>' + user.Nombres + ' ' + user.Apellidos + '</strong><br><small class="text-muted">' + user.Email + '</small>';
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            usuarioSelect.value = user.Id;
                            usuarioSearch.value = user.Nombres + ' ' + user.Apellidos + ' (' + user.Email + ')';
                            usuarioResults.style.display = 'none';
                        });
                        usuarioResults.appendChild(item);
                    });
                }
                usuarioResults.style.display = 'block';
            }, 300);
        });

        // Ocultar resultados al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!usuarioSearch.contains(e.target) && !usuarioResults.contains(e.target)) {
                usuarioResults.style.display = 'none';
            }
        });
    </script>
}
