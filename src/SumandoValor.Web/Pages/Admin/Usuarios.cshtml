@page
@model SumandoValor.Web.Pages.Admin.UsuariosModel
@using SumandoValor.Domain.Helpers
@{
    ViewData["Title"] = "Usuarios";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="admin-card">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <h1 class="h4 mb-1">Usuarios</h1>
            <div class="text-muted">Búsqueda, activación y roles.</div>
        </div>
    </div>

    <details class="mb-3">
        <summary class="fw-semibold">Crear nuevo usuario</summary>
        <div class="mt-3">
            <form method="post" asp-page-handler="Create" class="row g-3">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.Email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input asp-for="CreateInput.Email" class="form-control" autocomplete="off" />
                    <span asp-validation-for="CreateInput.Email" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="CreateInput.Password" class="form-label">Contraseña <span class="text-danger">*</span></label>
                    <input asp-for="CreateInput.Password" class="form-control" autocomplete="new-password" />
                    <span asp-validation-for="CreateInput.Password" class="text-danger"></span>
                    <small class="text-muted">Mín. 14 caracteres: mayúsculas, minúsculas, números y símbolos.</small>
                </div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.Nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
                    <input asp-for="CreateInput.Nombres" class="form-control" />
                    <span asp-validation-for="CreateInput.Nombres" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="CreateInput.Apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                    <input asp-for="CreateInput.Apellidos" class="form-control" />
                    <span asp-validation-for="CreateInput.Apellidos" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="CreateInput.Cedula" class="form-label">Cédula <span class="text-danger">*</span></label>
                    <input asp-for="CreateInput.Cedula" class="form-control" />
                    <span asp-validation-for="CreateInput.Cedula" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="CreateInput.Sexo" class="form-label">Sexo <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.Sexo" class="form-select">
                        <option value="">Seleccione...</option>
                        @foreach (var sexo in Catalogos.Sexos)
                        {
                            <option value="@sexo.Key">@sexo.Value</option>
                        }
                    </select>
                    <span asp-validation-for="CreateInput.Sexo" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="CreateInput.FechaNacimiento" class="form-label">Fecha de Nacimiento <span class="text-danger">*</span></label>
                    <input asp-for="CreateInput.FechaNacimiento" type="date" class="form-control" />
                    <span asp-validation-for="CreateInput.FechaNacimiento" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.NivelEducativo" class="form-label">Nivel Educativo <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.NivelEducativo" class="form-select">
                        <option value="">Seleccione...</option>
                        @foreach (var nivel in Catalogos.NivelesEducativos)
                        {
                            <option value="@nivel.Key">@nivel.Value</option>
                        }
                    </select>
                    <span asp-validation-for="CreateInput.NivelEducativo" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="CreateInput.SituacionLaboral" class="form-label">Situación Laboral <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.SituacionLaboral" class="form-select">
                        <option value="">Seleccione...</option>
                        @foreach (var situacion in Catalogos.SituacionesLaborales)
                        {
                            <option value="@situacion.Key">@situacion.Value</option>
                        }
                    </select>
                    <span asp-validation-for="CreateInput.SituacionLaboral" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.Sector" class="form-label">Sector <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.Sector" class="form-select">
                        <option value="">Seleccione...</option>
                        <option value="TercerSector">Tercer sector</option>
                        <option value="SectorPrivado">Sector privado</option>
                        <option value="SectorPublico">Sector público</option>
                        <option value="Academia">Academia</option>
                    </select>
                    <span asp-validation-for="CreateInput.Sector" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="CreateInput.Pais" class="form-label">País <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.Pais" class="form-select">
                        <option value="Venezuela" selected>Venezuela</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <span asp-validation-for="CreateInput.Pais" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.Estado" class="form-label">Estado <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.Estado" class="form-select">
                        <option value="">Seleccione...</option>
                        @foreach (var estado in Catalogos.EstadosVenezuela)
                        {
                            <option value="@estado.Key">@estado.Value</option>
                        }
                    </select>
                    <span asp-validation-for="CreateInput.Estado" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="CreateInput.Ciudad" class="form-label">Ciudad <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.Ciudad" class="form-select">
                        <option value="">Seleccione...</option>
                        @foreach (var ciudad in Catalogos.CiudadesVenezuela)
                        {
                            <option value="@ciudad.Key">@ciudad.Value</option>
                        }
                    </select>
                    <span asp-validation-for="CreateInput.Ciudad" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.CanalConocio" class="form-label">¿Cómo conoció la plataforma? <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.CanalConocio" class="form-select">
                        <option value="">Seleccione...</option>
                        @foreach (var canal in Catalogos.CanalesConocio)
                        {
                            <option value="@canal.Key">@canal.Value</option>
                        }
                    </select>
                    <span asp-validation-for="CreateInput.CanalConocio" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="CreateInput.Telefono" class="form-label">Teléfono</label>
                    <input asp-for="CreateInput.Telefono" class="form-control" />
                    <span asp-validation-for="CreateInput.Telefono" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="CreateInput.InitialRole" class="form-label">Rol inicial <span class="text-danger">*</span></label>
                    <select asp-for="CreateInput.InitialRole" class="form-select">
                        <option value="Beneficiario">Beneficiario</option>
                        <option value="Moderador">Moderador</option>
                    </select>
                    <small class="text-muted">Crear Moderador aquí funciona, pero igual puedes usar “Hacer Moderador” en la tabla.</small>
                    <span asp-validation-for="CreateInput.InitialRole" class="text-danger"></span>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Crear usuario</button>
                </div>
            </form>
        </div>
    </details>

    <form method="get" class="row g-2 align-items-end">
        <div class="col-md-2">
            <label class="form-label small">Nombre</label>
            <input class="form-control form-control-sm" name="SearchName" value="@Model.SearchName" placeholder="Nombre" />
        </div>
        <div class="col-md-2">
            <label class="form-label small">Email</label>
            <input class="form-control form-control-sm" name="SearchEmail" value="@Model.SearchEmail" placeholder="Email" />
        </div>
        <div class="col-md-2">
            <label class="form-label small">Cédula</label>
            <input class="form-control form-control-sm" name="SearchCedula" value="@Model.SearchCedula" placeholder="Buscar cédula..." />
        </div>
        <div class="col-md-2">
            <label class="form-label small">Estado</label>
            <select class="form-select form-select-sm" name="Status">
                <option value="">Todos</option>
                <option value="active" selected="@(Model.Status == "active")">Activos</option>
                <option value="inactive" selected="@(Model.Status == "inactive")">Inactivos</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small">Rol</label>
            <select class="form-select form-select-sm" name="Role">
                <option value="">Todos</option>
                <option value="Moderador" selected="@(Model.Role == "Moderador")">Moderador</option>
                <option value="Admin" selected="@(Model.Role == "Admin")">Admin</option>
                <option value="Beneficiario" selected="@(Model.Role == "Beneficiario")">Beneficiario</option>
            </select>
        </div>
        <div class="col-md-2 d-grid gap-1">
            <button class="btn btn-primary btn-sm" type="submit">Filtrar</button>
            <button class="btn btn-outline-secondary btn-sm" type="submit" asp-page-handler="ExportCsv" formmethod="post">Exportar CSV</button>
        </div>
    </form>
</div>

<div class="admin-card">
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
            <tr>
                <th>Usuario</th>
                <th>Email</th>
                <th>Cédula</th>
                <th>Estado</th>
                <th>Roles</th>
                <th class="text-center">Acciones</th>
            </tr>
            </thead>
            <tbody>
            @{
                // Only Admin can promote/revoke moderadores (avoid privilege escalation)
                var canManageModeradores = User.IsInRole("Admin");
                var canManageAdmins = User.IsInRole("Admin");
            }
            @foreach (var u in Model.Rows)
            {
                <tr>
                    <td>
                        <div class="fw-semibold">@u.FullName</div>
                    </td>
                    <td class="text-muted">@u.Email</td>
                    <td>@u.Cedula</td>
                    <td>
                        <span class="badge @(u.IsActive ? "bg-success" : "bg-secondary")">
                            @(u.IsActive ? "Activo" : "Inactivo")
                        </span>
                    </td>
                    <td>
                        @foreach (var r in u.Roles)
                        {
                            <span class="badge bg-light text-dark me-1">@r</span>
                        }
                    </td>
                    <td class="text-center">
                        <div class="admin-actions">
                            <a asp-page="/Admin/Usuarios/Edit" asp-route-id="@u.UserId"
                               class="btn btn-sm btn-outline-primary w-100 w-md-auto">
                                Editar
                            </a>

                            <form method="post" asp-page-handler="ToggleActive" asp-route-id="@u.UserId" class="m-0">
                                <button type="submit"
                                        class="btn btn-sm @(u.IsActive ? "btn-outline-secondary" : "btn-outline-success") w-100 w-md-auto"
                                        onclick="return confirm('¿Confirmas @(u.IsActive ? "desactivar" : "activar") este usuario?');">
                                    @(u.IsActive ? "Desactivar" : "Activar")
                                </button>
                            </form>

                            @if (u.Roles.Contains("Admin"))
                            {
                                @if (!canManageAdmins)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-primary w-100 w-md-auto" disabled
                                            title="Solo Admin puede gestionar Admins">
                                        Admin
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-sm btn-outline-primary w-100 w-md-auto" disabled
                                            title="Los Admins siempre conservan Moderador">
                                        Admin
                                    </button>
                                }
                            }
                            else if (canManageModeradores && !u.IsModerador)
                            {
                                <form method="post" asp-page-handler="MakeModerador" asp-route-id="@u.UserId" class="m-0">
                                    <button type="submit" class="btn btn-sm btn-outline-primary w-100 w-md-auto"
                                            onclick="return confirm('¿Convertir a Moderador a este usuario?');">
                                        Hacer Moderador
                                    </button>
                                </form>
                            }
                            else if (canManageModeradores && u.IsModerador && !u.Roles.Contains("Admin"))
                            {
                                <form method="post" asp-page-handler="RemoveModerador" asp-route-id="@u.UserId" class="m-0">
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100 w-md-auto"
                                            onclick="return confirm('¿Quitar rol Moderador a este usuario?');">
                                        Quitar Moderador
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button type="button" class="btn btn-sm btn-outline-primary w-100 w-md-auto" disabled
                                        title="Solo Admin puede gestionar Moderadores">
                                    Admin
                                </button>
                            }
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Paginación" class="mt-3">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                    <a class="page-link" href="@Model.PageUrl(Model.PageNumber - 1)">Anterior</a>
                </li>
                @for (var i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" href="@Model.PageUrl(i)">@i</a>
                    </li>
                }
                <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" href="@Model.PageUrl(Model.PageNumber + 1)">Siguiente</a>
                </li>
            </ul>
        </nav>
    }
</div>

