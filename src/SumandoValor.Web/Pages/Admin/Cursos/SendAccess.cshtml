@page "/Admin/Cursos/SendAccess/{id:int}"
@model SumandoValor.Web.Pages.Admin.Cursos.SendAccessModel
@{
    ViewData["Title"] = "Enviar Enlace de Acceso";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="mb-4">
    <h1>Enviar Enlace de Acceso</h1>
    <a asp-page="/Admin/Cursos" class="btn btn-link">← Volver a Programa Formativo</a>
</div>

@if (Model.Curso == null)
{
    <div class="alert alert-warning">
        <p class="mb-0">Programa Formativo no encontrado.</p>
    </div>
    <a asp-page="/Admin/Cursos" class="btn btn-secondary">Volver</a>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card card-kpmg">
                <div class="card-body p-4">
                    <h3 class="h5 mb-3">@Model.Curso.Titulo</h3>
                    
                    <form method="post">
                        <input type="hidden" asp-for="Input.CursoId" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Emails" class="form-label">Correos electrónicos *</label>
                            <textarea asp-for="Input.Emails" class="form-control" rows="4" 
                                placeholder="Un correo por línea, o separados por coma o punto y coma. Ej:&#10;usuario1@ejemplo.com&#10;usuario2@ejemplo.com"></textarea>
                            <span asp-validation-for="Input.Emails" class="text-danger"></span>
                            <small class="text-muted">Ingresa uno o más correos. Se enviará el enlace a cada destinatario.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">O agregar usuario registrado</label>
                            <div class="input-group">
                                <select id="userSelect" class="form-select">
                                    <option value="">Seleccionar para agregar...</option>
                                    @foreach (var user in Model.Usuarios)
                                    {
                                        <option value="@user.Email">@user.Nombres @user.Apellidos (@user.Email)</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-secondary" id="btnAddUser" title="Agregar a la lista">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.DiasExpiracion" class="form-label">Días de validez del enlace</label>
                            <input asp-for="Input.DiasExpiracion" class="form-control" type="number" min="1" max="365" value="30" />
                            <span asp-validation-for="Input.DiasExpiracion" class="text-danger"></span>
                            <small class="text-muted">El enlace expirará después de este número de días.</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Generar y Enviar Enlace a Todos</button>
                            <a asp-page="/Admin/Cursos" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    @if (Model.Curso != null)
    {
        <script>
            (function() {
                var select = document.getElementById('userSelect');
                var textarea = document.getElementById('Input_Emails');
                var btnAdd = document.getElementById('btnAddUser');
                if (!select || !textarea) return;
                function addEmail(email) {
                    if (!email) return;
                    var current = (textarea.value || '').trim();
                    var emails = current ? current.split(/[\n,;]+/).map(function(e){ return e.trim(); }).filter(Boolean) : [];
                    if (emails.indexOf(email) === -1) {
                        emails.push(email);
                        textarea.value = emails.join('\n');
                    }
                    select.value = '';
                }
                select.addEventListener('change', function() { addEmail(this.value); });
                if (btnAdd) btnAdd.addEventListener('click', function() { addEmail(select.value); });
            })();
        </script>
    }
}
