@page "{id:int}"
@model SumandoValor.Web.Pages.Admin.SurveyTemplates.EditModel
@using SumandoValor.Domain.Entities.Surveys
@{
    ViewData["Title"] = "Editar encuesta";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

@if (Model.Template == null)
{
    <div class="admin-card">
        <div class="alert alert-warning mb-0">Plantilla no encontrada.</div>
    </div>
    <div class="admin-card">
        <a asp-page="/Admin/SurveyTemplates/Index" class="btn btn-outline-secondary">Volver</a>
    </div>
}
else
{
    <div class="admin-card">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
            <div>
                <h1 class="h4 mb-1"><i class="bi bi-clipboard-check me-2"></i>@Model.Template.Name</h1>
                <p class="text-muted mb-0">@Model.ScopeText</p>
            </div>
            <a asp-page="/Admin/SurveyTemplates/Index" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Volver</a>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light py-2">
                <h6 class="mb-0"><i class="bi bi-pencil me-2"></i>Configuración general</h6>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="UpdateTemplate" class="row g-3">
                    <input type="hidden" name="Id" value="@Model.Template.Id" />
                    <div class="col-md-8">
                        <label class="form-label">Nombre</label>
                        <input class="form-control" name="Name" value="@Model.Template.Name" maxlength="200" required />
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" name="IsActive" value="true" @(Model.Template.IsActive ? "checked" : "") />
                            <label class="form-check-label">Encuesta activa</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit"><i class="bi bi-check me-1"></i>Guardar</button>
                    </div>
                </form>

                <hr />

                <form method="post" asp-page-handler="UpdateDescription" class="row g-3">
                    <input type="hidden" name="Id" value="@Model.Template.Id" />
                    <div class="col-12">
                        <label class="form-label">Descripción para participantes</label>
                        <textarea class="form-control" name="Description" rows="3" maxlength="4000" placeholder="Texto introductorio que verán los participantes">@Model.Template.Description</textarea>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-outline-primary btn-sm" type="submit">Guardar descripción</button>
                    </div>
                </form>
            </div>
        </div>

        <form method="post" asp-page-handler="DeleteTemplate" asp-route-id="@Model.Template.Id"
              onsubmit="return confirm('¿Eliminar esta encuesta? Se borrarán también todas sus preguntas.');">
            <button class="btn btn-outline-danger btn-sm" type="submit"><i class="bi bi-trash me-1"></i>Eliminar encuesta</button>
        </form>
    </div>

    <div class="admin-card">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div>
                <h2 class="h5 mb-1"><i class="bi bi-list-ol me-2"></i>Preguntas</h2>
                <p class="text-muted small mb-0">Agrega y ordena las preguntas. Tipos: descripción, texto, puntaje 1-5, numérico o opciones.</p>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th style="width: 90px;">Orden</th>
                    <th>Tipo</th>
                    <th>Texto</th>
                    <th>Requerida</th>
                    <th class="text-center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var q in Model.Questions)
                {
                    <tr>
                        <td>@q.Order</td>
                        <td class="text-muted">@q.Type</td>
                        <td>@q.Text</td>
                        <td>@(q.IsRequired ? "Sí" : "No")</td>
                        <td class="text-center">
                            <div class="d-inline-flex gap-2">
                                <form method="post" asp-page-handler="MoveQuestionUp" asp-route-id="@Model.Template.Id" class="m-0">
                                    <input type="hidden" name="QuestionId" value="@q.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Subir" @(q.CanMoveUp ? "" : "disabled")>
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                </form>
                                <form method="post" asp-page-handler="MoveQuestionDown" asp-route-id="@Model.Template.Id" class="m-0">
                                    <input type="hidden" name="QuestionId" value="@q.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Bajar" @(q.CanMoveDown ? "" : "disabled")>
                                        <i class="bi bi-arrow-down"></i>
                                    </button>
                                </form>
                                <form method="post" asp-page-handler="DeleteQuestion" asp-route-id="@Model.Template.Id" class="m-0"
                                      onsubmit="return confirm('¿Eliminar esta pregunta?');">
                                    <input type="hidden" name="QuestionId" value="@q.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        <hr class="my-4" />

        <h6 class="mb-3"><i class="bi bi-plus-circle me-2"></i>Agregar pregunta</h6>
        <form method="post" asp-page-handler="AddQuestion" class="row g-3 card card-body bg-light">
            <input type="hidden" name="Id" value="@Model.Template.Id" />
            <div class="col-md-3">
                <label class="form-label">Tipo de pregunta</label>
                <select class="form-select" name="Type" required>
                    <option value="@SurveyQuestionType.Description">Descripción (texto largo)</option>
                    <option value="@SurveyQuestionType.Text">Texto (corto/medio)</option>
                    <option value="@SurveyQuestionType.Rating1To5">Puntaje (radio 1–5)</option>
                    <option value="@SurveyQuestionType.ScoreNumber">Puntaje (numérico)</option>
                    <option value="@SurveyQuestionType.SingleChoice">Radio (opciones)</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Texto</label>
                <input class="form-control" name="Text" maxlength="500" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Requerida</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="IsRequired" value="true" checked />
                    <label class="form-check-label">Sí</label>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Mín (solo “Puntaje numérico”)</label>
                <input class="form-control" type="number" name="Min" value="1" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Máx (solo “Puntaje numérico”)</label>
                <input class="form-control" type="number" name="Max" value="5" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Step (solo “Puntaje numérico”)</label>
                <input class="form-control" type="number" name="Step" value="1" />
            </div>
            <div class="col-12">
                <label class="form-label">Opciones (solo para “Radio (opciones)”, una por línea)</label>
                <textarea class="form-control" name="Options" rows="3" maxlength="4000"></textarea>
            </div>
            <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-plus-lg me-1"></i>Agregar pregunta</button>
            </div>
        </form>
    </div>
}

