SMTP PROBE (IIS) — detectar si el servidor responde el banner SMTP (220) y qué puerto funciona

1) Abrir PowerShell COMO ADMIN en el servidor IIS.

2) Pegar y ejecutar:

$hostName = "mail.ve.kworld.kpmg.com"
$ports = @(25,587)

Write-Host "== DNS (A/AAAA) ==" -ForegroundColor Cyan
try { Resolve-DnsName $hostName -Type A   | Select-Object Name,IPAddress } catch { Write-Host $_ -ForegroundColor Yellow }
try { Resolve-DnsName $hostName -Type AAAA| Select-Object Name,IPAddress } catch { Write-Host $_ -ForegroundColor Yellow }

function Read-SmtpBanner {
  param(
    [string]$TargetHost,
    [int]$Port,
    [int]$TimeoutMs = 5000
  )

  $client = New-Object System.Net.Sockets.TcpClient
  try {
    $ar = $client.BeginConnect($TargetHost, $Port, $null, $null)
    if (-not $ar.AsyncWaitHandle.WaitOne($TimeoutMs)) {
      throw "CONNECT timeout (${TimeoutMs}ms)"
    }
    $client.EndConnect($ar)

    $stream = $client.GetStream()
    $stream.ReadTimeout  = $TimeoutMs
    $stream.WriteTimeout = $TimeoutMs

    $reader = New-Object System.IO.StreamReader($stream)
    $line = $reader.ReadLine()
    return $line
  }
  finally {
    $client.Close()
  }
}

foreach ($p in $ports) {
  Write-Host "== PROBANDO $hostName:$p ==" -ForegroundColor Cyan
  try {
    $banner = Read-SmtpBanner -TargetHost $hostName -Port $p -TimeoutMs 5000
    if ([string]::IsNullOrWhiteSpace($banner)) {
      Write-Host "SIN BANNER (conectó pero no respondió linea 1)" -ForegroundColor Yellow
    } else {
      Write-Host "BANNER: $banner" -ForegroundColor Green
    }
  } catch {
    Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
  }
}

3) Interpretación rápida:
- Si en 25 NO hay banner (o CONNECT timeout): IT/firewall/relay está bloqueando a nivel de aplicación.
- Si en 587 sí hay banner: usa SMTP autenticado (587 + TLS) en la app.
- Si hay banner en ambos: el SMTP responde; entonces el problema es auth/relay/FromAddress (saldrá como SmtpException, no Timeout).

